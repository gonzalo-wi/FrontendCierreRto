<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Jumillano</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .reparto-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .reparto-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .reparto-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
        }
        .amount {
            font-family: monospace;
            font-weight: bold;
        }
        .estado-exacto { color: #28a745; }
        .estado-faltante { color: #dc3545; }
        .estado-sobrante { color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Test API Jumillano - Fecha 07-02-2025</h1>
        
        <div>
            <button class="btn" onclick="testAPI()">üöÄ Probar API</button>
            <button class="btn" onclick="clearResults()">üßπ Limpiar</button>
        </div>
        
        <div id="status"></div>
        <div id="results"></div>
    </div>

    <script type="module">
        async function testAPI() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<p class="loading">üîÑ Cargando datos de la API...</p>';
            resultsDiv.innerHTML = '';
            
            try {
                console.log('üîç Probando API de Jumillano para fecha: 07-02-2025');
                
                // Llamada directa a la API
                const response = await fetch('/api/deposits/jumillano?date=07-02-2025', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Respuesta de API recibida:', data);
                
                // Procesar y mostrar datos
                const repartos = processAPIData(data);
                displayResults(repartos);
                
                statusDiv.innerHTML = `<p class="success">‚úÖ API funcionando correctamente - ${repartos.length} repartos encontrados</p>`;
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                statusDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        function processAPIData(apiData) {
            const repartos = [];
            
            // Montos esperados simulados
            const montosEsperados = {
                'RTO-001': 450000, 'RTO-002': 320000, 'RTO-003': 480000, 'RTO-004': 475000,
                'RTO-005': 455000, 'RTO-006': 700000, 'RTO-007': 520000, 'RTO-008': 340000,
                'RTO-009': 490000, 'RTO-010': 430000, 'RTO-011': 715000, 'RTO-012': 485000,
                'RTO-013': 380000, 'RTO-014': 535000, 'RTO-015': 515000, 'RTO-016': 350000,
                'RTO-017': 540000, 'RTO-018': 365000, 'RTO-019': 655000, 'RTO-020': 225000,
                'RTO-021': 405000, 'RTO-022': 435000, 'RTO-023': 565000, 'RTO-024': 585000,
                'RTO-025': 370000, 'RTO-026': 420000, 'RTO-027': 445000, 'RTO-028': 390000,
                'RTO-029': 400000, 'RTO-030': 430000, 'RTO-031': 795000, 'RTO-032': 410000,
                'RTO-033': 370000, 'RTO-034': 665000, 'RTO-035': 440000, 'RTO-036': 765000,
                'RTO-037': 365000, 'RTO-038': 385000, 'RTO-039': 380000, 'RTO-040': 630000,
                'RTO-041': 230000, 'RTO-042': 410000, 'RTO-043': 675000, 'RTO-044': 590000,
                'RTO-045': 345000, 'RTO-046': 400000, 'RTO-047': 460000, 'RTO-048': 595000,
                'RTO-049': 615000, 'RTO-050': 245000, 'RTO-051': 370000, 'RTO-052': 235000,
                'RTO-053': 555000, 'RTO-054': 455000, 'RTO-055': 565000, 'RTO-056': 1090000,
                'RTO-057': 605000, 'RTO-058': 485000, 'RTO-059': 810000, 'RTO-060': 715000,
                'RTO-061': 320000, 'RTO-062': 225000, 'RTO-063': 610000, 'RTO-064': 260000,
                'RTO-065': 200000, 'RTO-066': 345000, 'RTO-067': 995000, 'RTO-068': 4000,
                'RTO-069': 325000, 'RTO-070': 205000, 'RTO-071': 280000, 'RTO-072': 415000,
                'RTO-073': 415000, 'RTO-074': 430000, 'RTO-075': 175000, 'RTO-076': 510000,
                'RTO-077': 335000, 'RTO-078': 290000, 'RTO-079': 705000, 'RTO-080': 480000,
                'RTO-081': 230000, 'RTO-082': 255000, 'RTO-083': 595000, 'RTO-084': 695000,
                'RTO-085': 435000, 'RTO-087': 700000, 'RTO-089': 415000, 'RTO-090': 600000,
                'RTO-091': 640000, 'RTO-092': 400000, 'RTO-093': 375000, 'RTO-094': 335000,
                'RTO-095': 615000, 'RTO-096': 590000, 'RTO-097': 375000, 'RTO-098': 495000,
                'RTO-099': 445000, 'RTO-100': 355000, 'RTO-101': 385000, 'RTO-102': 350000,
                'RTO-104': 305000, 'RTO-105': 200000, 'RTO-106': 325000, 'RTO-107': 190000,
                'RTO-109': 420000, 'RTO-110': 175000, 'RTO-111': 480000, 'RTO-112': 215000,
                'RTO-114': 315000, 'RTO-115': 265000, 'RTO-116': 200000, 'RTO-117': 275000,
                'RTO-118': 180000, 'RTO-119': 185000, 'RTO-120': 425000, 'RTO-121': 140000,
                'RTO-122': 185000, 'RTO-157': 35000, 'RTO-158': 70000, 'RTO-159': 15000,
                'RTO-163': 120000, 'RTO-164': 30000, 'RTO-170': 160000, 'RTO-171': 490000,
                'RTO-172': 285000, 'RTO-173': 320000, 'RTO-174': 12000, 'RTO-176': 390000
            };
            
            // Procesar cada identificador
            Object.keys(apiData).forEach(identifier => {
                const depositData = apiData[identifier];
                
                if (depositData.ArrayOfWSDepositsByDayDTO && depositData.ArrayOfWSDepositsByDayDTO.WSDepositsByDayDTO) {
                    const deposits = depositData.ArrayOfWSDepositsByDayDTO.WSDepositsByDayDTO;
                    const depositsArray = Array.isArray(deposits) ? deposits : [deposits];
                    
                    const repartosPorUsuario = {};
                    
                    depositsArray.forEach(deposit => {
                        const userNameMatch = deposit.userName.match(/RTO\\s+(\\d+)/);
                        const numeroReparto = userNameMatch ? userNameMatch[1] : deposit.userName;
                        const repartoKey = `RTO-${numeroReparto}`;
                        
                        if (!repartosPorUsuario[repartoKey]) {
                            repartosPorUsuario[repartoKey] = {
                                id: `${identifier}-${numeroReparto}`,
                                idReparto: repartoKey,
                                fechaReparto: '07-02-2025',
                                numeroReparto: numeroReparto,
                                userName: deposit.userName,
                                identifier: identifier,
                                posName: deposit.posName,
                                stName: deposit.stName,
                                entityName: deposit.entityName,
                                depositoReal: 0,
                                depositoEsperado: montosEsperados[repartoKey] || 0,
                                diferencia: 0,
                                estado: 'PENDIENTE',
                                deposits: []
                            };
                        }
                        
                        const amount = parseFloat(deposit.currencies.WSDepositCurrency.totalAmount) || 0;
                        repartosPorUsuario[repartoKey].depositoReal += amount;
                        repartosPorUsuario[repartoKey].deposits.push(deposit);
                    });
                    
                    Object.values(repartosPorUsuario).forEach(reparto => {
                        reparto.diferencia = reparto.depositoReal - reparto.depositoEsperado;
                        
                        if (reparto.diferencia === 0) {
                            reparto.estado = 'EXACTO';
                        } else if (reparto.diferencia > 0) {
                            reparto.estado = 'SOBRANTE';
                        } else {
                            reparto.estado = 'FALTANTE';
                        }
                        
                        repartos.push(reparto);
                    });
                }
            });
            
            return repartos.sort((a, b) => a.numeroReparto.localeCompare(b.numeroReparto));
        }
        
        function displayResults(repartos) {
            const resultsDiv = document.getElementById('results');
            
            if (repartos.length === 0) {
                resultsDiv.innerHTML = '<p>No se encontraron repartos.</p>';
                return;
            }
            
            let html = `<h2>üìä Resultados (${repartos.length} repartos)</h2>`;
            
            // Estad√≠sticas
            const exactos = repartos.filter(r => r.estado === 'EXACTO').length;
            const faltantes = repartos.filter(r => r.estado === 'FALTANTE').length;
            const sobrantes = repartos.filter(r => r.estado === 'SOBRANTE').length;
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0;">
                    <div style="background: #d4edda; padding: 10px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #155724;">${exactos}</div>
                        <div style="color: #155724;">Exactos</div>
                    </div>
                    <div style="background: #f8d7da; padding: 10px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #721c24;">${faltantes}</div>
                        <div style="color: #721c24;">Faltantes</div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #856404;">${sobrantes}</div>
                        <div style="color: #856404;">Sobrantes</div>
                    </div>
                </div>
            `;
            
            // Lista de repartos (solo los primeros 10 para no saturar)
            html += '<h3>üìã Primeros 10 repartos:</h3>';
            
            repartos.slice(0, 10).forEach(reparto => {
                const estadoClass = `estado-${reparto.estado.toLowerCase()}`;
                html += `
                    <div class="reparto-card">
                        <div class="reparto-header">
                            ${reparto.idReparto} - ${reparto.userName}
                            <span class="${estadoClass}" style="float: right;">${reparto.estado}</span>
                        </div>
                        <div class="reparto-details">
                            <div class="detail-item">
                                <span>Dep√≥sito Real:</span>
                                <span class="amount">$${reparto.depositoReal.toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span>Dep√≥sito Esperado:</span>
                                <span class="amount">$${reparto.depositoEsperado.toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span>Diferencia:</span>
                                <span class="amount ${estadoClass}">$${reparto.diferencia.toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span>Terminal:</span>
                                <span>${reparto.stName}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (repartos.length > 10) {
                html += `<p style="text-align: center; color: #666; font-style: italic;">... y ${repartos.length - 10} repartos m√°s</p>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function clearResults() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }
        
        // Hacer funciones globales
        window.testAPI = testAPI;
        window.clearResults = clearResults;
        
        // Auto-test al cargar
        console.log('üöÄ P√°gina de test cargada. Probando API autom√°ticamente...');
        setTimeout(testAPI, 1000);
    </script>
</body>
</html>
